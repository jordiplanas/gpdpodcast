<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio GuÃ­a con Mapa</title>
    
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.12.0/NoSleep.min.js"></script>

    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        #map { flex-grow: 1; height: 70vh;  width: 100%;background: #e0e0e0; } 
        .ui-panel { padding: 15px; background: white; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        button { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        #startBtn { background: #007bff; color: white; }
        #restartBtn { background: #dc3545; color: white; }
        select { width: 100%; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="ui-panel">
    <select id="idioma">
        <option value="es">EspaÃ±ol ðŸ‡ªðŸ‡¸</option>
        <option value="en">English ðŸ‡¬ðŸ‡§</option>
        <option value="fr">FranÃ§ais ðŸ‡«ðŸ‡·</option>
        </select>

    <div class="controls">
        <button id="startBtn">COMENZAR</button>
        <button id="restartBtn">REINICIAR</button>
    </div>
    <div id="status" style="font-size: 12px; margin-top: 5px; text-align: center;">Pulsa comenzar para activar GPS</div>
</div>

<script>
    const noSleep = new NoSleep();
    let map, userMarker, watchID;
    const puntosInteres = [
        { id: "Punto 1", lat: 41.481406, lng: 2.073040, audio: 'punto1.mp3', reproducido: false },
        { id: "Punto 2", lat: 41.467869, lng: 2.078233, audio: 'punto2.mp3', reproducido: false }
    ];
    const audioPlayer = new Audio();

    // Inicializar Mapa
    function initMap() {
        map = L.map('map').setView([41.481406, 2.073040], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // Dibujar los puntos de interÃ©s en el mapa
        puntosInteres.forEach(p => {
            L.marker([p.lat, p.lng]).addTo(map).bindPopup(p.id);
            L.circle([p.lat, p.lng], { radius: 150, color: 'blue', fillOpacity: 0.1 }).addTo(map);
        });

        // Marcador del usuario (cÃ­rculo rojo)
        userMarker = L.circleMarker([0,0], { radius: 8, color: 'red', fillColor: '#f03', fillOpacity: 1 }).addTo(map);
    }

    function getDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    document.getElementById('startBtn').addEventListener('click', function() {
        noSleep.enable();
        this.disabled = true;
        this.innerText = "ACTIVO";
        
        watchID = navigator.geolocation.watchPosition(pos => {
            const { latitude, longitude } = pos.coords;
            const idioma = document.getElementById('idioma').value;
            
            // Actualizar posiciÃ³n del usuario en el mapa
            const newPos = [latitude, longitude];
            userMarker.setLatLng(newPos);
            map.panTo(newPos); // El mapa sigue al coche

            puntosInteres.forEach(p => {
                const dist = getDistancia(latitude, longitude, p.lat, p.lng);
                if (dist < 0.15 && !p.reproducido) {
                    p.reproducido = true;
                    audioPlayer.src = `./audios/${idioma}/${p.audio}`;
                    audioPlayer.play();
                    document.getElementById('status').innerText = "Reproduciendo: " + p.id;
                }
            });
        }, err => console.error(err), { enableHighAccuracy: true });
    });

    document.getElementById('restartBtn').addEventListener('click', () => {
        puntosInteres.forEach(p => p.reproducido = false);
        alert("Tour reiniciado");
    });

    initMap();
</script>
</body>
</html>
