<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio GuÃ­a GPS - Configurable</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.12.0/NoSleep.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; background: #f0f2f5; }
        #map { flex-grow: 1; height: 60vh; width: 100%; }
        
        .ui-panel { 
            padding: 20px; 
            background: white; 
            z-index: 1000; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15); 
            border-radius: 25px 25px 0 0;
        }

        /* Barra de progreso */
        .progress-container {
            width: 100%;
            background: #e9ecef;
            height: 12px;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }
        #progress-bar {
            width: 0%;
            height: 100%;
            background: #28a745;
            transition: width 0.3s linear;
        }

        /* Historial de audios */
        #historial {
            margin-top: 15px;
            max-height: 100px;
            overflow-y: auto;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .visto-item {
            font-size: 14px;
            color: #2c3e50;
            padding: 4px 0;
            border-bottom: 1px solid #fafafa;
        }

        /* Controles */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
        button { 
            padding: 16px; 
            border-radius: 12px; 
            border: none; 
            font-weight: bold; 
            font-size: 14px;
            cursor: pointer;
        }
        #startBtn { background: #007bff; color: white; }
        #restartBtn { background: #6c757d; color: white; }
        button:disabled { background: #bdc3c7; }
        
        select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; }
        #status { font-size: 13px; margin-top: 10px; text-align: center; color: #7f8c8d; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="ui-panel">
    <select id="idioma">
        <option value="es">EspaÃ±ol ðŸ‡ªðŸ‡¸</option>
        <option value="en">English ðŸ‡¬ðŸ‡§</option>
        <option value="fr">FranÃ§ais ðŸ‡«ðŸ‡·</option>
    </select>

    <div class="progress-container">
        <div id="progress-bar"></div>
    </div>

    <div class="controls">
        <button id="startBtn">INICIAR TOUR</button>
        <button id="restartBtn">REINICIAR</button>
    </div>

    <div id="status">Esperando seÃ±al GPS...</div>

    <div id="historial">
        <div style="font-size: 11px; font-weight: bold; color: #bdc3c7; letter-spacing: 1px;">AUDIOS COMPLETADOS</div>
        <div id="lista-reproducidos"></div>
    </div>
</div>

<script>
    // ==========================================
    // CONFIGURACIÃ“N DE LOS PUNTOS (EDITA AQUÃ)
    // ==========================================
    const CONFIG_PUNTOS = [
        { 
            id: "Punto 1: El Inicio", 
            lat: 41.377718, //41.377718,2.129175
            lng: 2.129175, 
            radio: 0.50, // Radio en kilÃ³metros (150m)
            audio: 'punto1.mp3' 
        },
        { 
            id: "Punto 2: Plaza Mayor", 
            lat: 41.379118, 
            lng: 2.128891, 
            radio: 0.50, // Radio en kilÃ³metros (100m) 41.379118,2.128891
            audio: 'punto2.mp3' 
        },
        { 
            id: "Punto 3: Final de Ruta", //41.376921,2.129695
            lat: 41.376921, 
            lng: 2.129695, 
            radio: 0.50, 
            audio: 'punto3.mp3' 
        }
    ];

    // ==========================================
    // LÃ“GICA DEL SISTEMA (NO TOCAR SI NO ES NECESARIO)
    // ==========================================
    const noSleep = new NoSleep();
    let map, userMarker, watchID;
    const puntosInteres = CONFIG_PUNTOS.map(p => ({ ...p, reproducido: false }));
    const audioPlayer = new Audio();

    // 1. Inicializar Mapa
    function initMap() {
        map = L.map('map').setView([puntosInteres[0].lat, puntosInteres[0].lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // Dibujar puntos y sus Ã¡reas de activaciÃ³n
        puntosInteres.forEach(p => {
            L.marker([p.lat, p.lng]).addTo(map).bindPopup(p.id);
            L.circle([p.lat, p.lng], { 
                radius: p.radio * 1000, // Convertir km a metros
                color: '#3498db', 
                fillOpacity: 0.1 
            }).addTo(map);
        });

        // Marcador usuario
        userMarker = L.circleMarker([0,0], { radius: 9, color: 'white', weight: 3, fillColor: '#e74c3c', fillOpacity: 1 }).addTo(map);
    }

    // 2. CÃ¡lculo de distancia
    function getDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    // 3. Control de Audio y Progreso
    audioPlayer.addEventListener('timeupdate', () => {
        if (audioPlayer.duration) {
            const porcentaje = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            document.getElementById('progress-bar').style.width = porcentaje + '%';
        }
    });

    audioPlayer.addEventListener('ended', () => {
        document.getElementById('progress-bar').style.width = '0%';
        document.getElementById('status').innerText = "Audio finalizado. Buscando siguiente punto...";
    });

    function registrarVisto(nombre) {
        const lista = document.getElementById('lista-reproducidos');
        const item = document.createElement('div');
        item.className = 'visto-item';
        item.innerHTML = `âœ… ${nombre}`;
        lista.prepend(item);
    }

    // 4. ActivaciÃ³n GPS
    document.getElementById('startBtn').addEventListener('click', function() {
        noSleep.enable();
        this.disabled = true;
        this.innerText = "GPS ACTIVO";
        
        watchID = navigator.geolocation.watchPosition(pos => {
            const { latitude, longitude } = pos.coords;
            const idioma = document.getElementById('idioma').value;
            
            const newPos = [latitude, longitude];
            userMarker.setLatLng(newPos);
            map.flyTo(newPos, 16);

            puntosInteres.forEach(p => {
                const dist = getDistancia(latitude, longitude, p.lat, p.lng);
                
                // Si entra en el radio individual de cada punto
                if (dist < p.radio && !p.reproducido) {
                    p.reproducido = true;
                    audioPlayer.src = `./audios/${idioma}/${p.audio}`;
                    audioPlayer.play();
                    
                    document.getElementById('status').innerText = "ðŸ”Š Reproduciendo: " + p.id;
                    registrarVisto(p.id);
                }
            });
        }, err => console.error(err), { enableHighAccuracy: true });
    });

    // 5. Reiniciar
    document.getElementById('restartBtn').addEventListener('click', () => {
        puntosInteres.forEach(p => p.reproducido = false);
        document.getElementById('lista-reproducidos').innerHTML = "";
        document.getElementById('progress-bar').style.width = "0%";
        alert("Ruta reseteada.");
    });

    initMap();
</script>
</body>
</html>
